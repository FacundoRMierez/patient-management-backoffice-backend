// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================
enum ProfessionalType {
  PSYCHOLOGIST      // Psicólogo
  DOCTOR            // Médico
  PSYCHIATRIST      // Psiquiatra
  PSYCHOPEDAGOGUE   // Psicopedagogo
  DENTIST           // Odontólogo
  NUTRITIONIST      // Nutricionista
  SPEECH_THERAPIST  // Fonoaudiólogo
  OCCUPATIONAL_THERAPIST // Terapista Ocupacional
  OTHER             // Otro
}

enum TaxCondition {
  RESPONSABLE_INSCRIPTO     // Responsable Inscripto
  MONOTRIBUTO               // Monotributo
  EXENTO                    // Exento
  CONSUMIDOR_FINAL          // Consumidor Final
}

enum PatientStatus {
  PENDING   // Pendiente de aprobación
  APPROVED  // Aprobado
  INACTIVE  // Inactivo
}

// ============================================
// USER MODEL
// ============================================
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  firstName String   @map("first_name")
  lastName  String   @map("last_name")
  
  // Organization details
  organizationName String? @map("organization_name")
  address          String?
  phoneNumber      String? @map("phone_number")
  
  // Professional details (if applicable)
  professionalType    ProfessionalType?  @map("professional_type")
  licenseNumber       String?            @map("license_number")
  specialization      String?
  
  // Account status
  isDeleted        Boolean  @default(false) @map("is_deleted")
  isApproved       Boolean  @default(false) @map("is_approved")
  isActive         Boolean  @default(true)  @map("is_active")
  
  // Email verification
  emailVerified    Boolean  @default(false) @map("email_verified")
  verificationToken String? @unique @map("verification_token")
  
  // Password reset
  resetPasswordToken   String?   @unique @map("reset_password_token")
  resetPasswordExpires DateTime? @map("reset_password_expires")
  
  // Timestamps
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")
  lastLoginAt      DateTime? @map("last_login_at")
  
  // Relations
  roles       UserRole[]
  patients    Patient[]  // Pacientes que creó este profesional
  
  @@map("users")
  @@index([email])
  @@index([isDeleted, isApproved])
}

// ============================================
// ROLE MODEL
// ============================================
model Role {
  id          String   @id @default(uuid())
  name        String   @unique // SUPER_ADMIN, PROFESSIONAL, PATIENT
  description String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  // Relations
  users       UserRole[]
  permissions RolePermission[]
  
  @@map("roles")
  @@index([name])
}

// ============================================
// USER-ROLE (Many-to-Many)
// ============================================
model UserRole {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  roleId    String   @map("role_id")
  assignedAt DateTime @default(now()) @map("assigned_at")
  assignedBy String?  @map("assigned_by") // User ID who assigned the role
  
  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)
  
  @@unique([userId, roleId])
  @@map("user_roles")
  @@index([userId])
  @@index([roleId])
}

// ============================================
// PERMISSION MODEL
// ============================================
model Permission {
  id          String   @id @default(uuid())
  name        String   @unique // users:create, users:read, users:approve, patients:create, etc.
  description String?
  resource    String   // users, patients, appointments, etc.
  action      String   // create, read, update, delete, approve, etc.
  createdAt   DateTime @default(now()) @map("created_at")
  
  // Relations
  roles RolePermission[]
  
  @@map("permissions")
  @@index([resource, action])
}

// ============================================
// ROLE-PERMISSION (Many-to-Many)
// ============================================
model RolePermission {
  id           String   @id @default(uuid())
  roleId       String   @map("role_id")
  permissionId String   @map("permission_id")
  grantedAt    DateTime @default(now()) @map("granted_at")
  
  // Relations
  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  
  @@unique([roleId, permissionId])
  @@map("role_permissions")
  @@index([roleId])
  @@index([permissionId])
}

// ============================================
// PATIENT MODEL
// ============================================
model Patient {
  id              String        @id @default(uuid())
  dni             String        @unique
  cut             String?       @map("cut") // Código Único de Tramitación
  firstName       String        @map("first_name")
  lastName        String        @map("last_name")
  dateOfBirth     DateTime      @map("date_of_birth")
  address         String
  phoneNumber     String?       @map("phone_number")
  email           String?
  
  // Ownership - Profesional que creó el paciente
  professionalId  String        @map("professional_id")
  professional    User          @relation(fields: [professionalId], references: [id], onDelete: Restrict)
  
  // Status management
  status          PatientStatus @default(PENDING)
  isActive        Boolean       @default(true) @map("is_active")
  isDeleted       Boolean       @default(false) @map("is_deleted")
  
  // Audit timestamps - Fechas de acciones cruciales
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")
  approvedAt      DateTime?     @map("approved_at")      // Cuándo se aprobó
  deactivatedAt   DateTime?     @map("deactivated_at")   // Cuándo se desactivó
  deletedAt       DateTime?     @map("deleted_at")       // Cuándo se eliminó (soft delete)
  
  // Audit users - Quién realizó cada acción
  createdBy       String?       @map("created_by")       // ID del usuario que creó
  approvedBy      String?       @map("approved_by")      // ID del usuario que aprobó
  lastModifiedBy  String?       @map("last_modified_by") // ID del último que modificó
  
  // Relations
  healthInsurance HealthInsurance?
  guardians       Guardian[]
  schoolInfo      SchoolInfo?
  billingInfo     BillingInfo?
  
  @@map("patients")
  @@index([professionalId])
  @@index([dni])
  @@index([status, isActive, isDeleted])
  @@index([createdAt])
}

// ============================================
// HEALTH INSURANCE (Obra Social)
// ============================================
model HealthInsurance {
  id              String   @id @default(uuid())
  patientId       String   @unique @map("patient_id")
  insuranceName   String   @map("insurance_name")
  affiliateNumber String?  @map("affiliate_number")
  
  // Relations
  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  @@map("health_insurance")
}

// ============================================
// GUARDIAN (Progenitores/Tutores)
// ============================================
model Guardian {
  id         String  @id @default(uuid())
  patientId  String  @map("patient_id")
  type       String  // 'A', 'B' (Progenitor A, Progenitor B)
  firstName  String  @map("first_name")
  lastName   String  @map("last_name")
  dni        String?
  phoneNumber String? @map("phone_number")
  email      String?
  occupation String?
  isLegalGuardian Boolean @default(false) @map("is_legal_guardian")
  
  // Relations
  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  @@map("guardians")
  @@index([patientId])
}

// ============================================
// SCHOOL INFO (Datos Escolares)
// ============================================
model SchoolInfo {
  id           String  @id @default(uuid())
  patientId    String  @unique @map("patient_id")
  schoolName   String  @map("school_name")
  schoolAddress String @map("school_address")
  grade        String  // Curso/Grado
  observations String? @db.Text
  
  // Relations
  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  @@map("school_info")
}

// ============================================
// BILLING INFO (Datos de Facturación)
// ============================================
model BillingInfo {
  id              String       @id @default(uuid())
  patientId       String       @unique @map("patient_id")
  requiresBilling Boolean      @default(false) @map("requires_billing")
  businessName    String?      @map("business_name") // Razón Social
  taxId           String?      @map("tax_id") // CUIT/CUIL
  taxCondition    TaxCondition? @map("tax_condition")
  fiscalAddress   String?      @map("fiscal_address")
  billingEmail    String?      @map("billing_email")
  
  // Relations
  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  @@map("billing_info")
}

